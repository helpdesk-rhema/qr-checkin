<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>QR Check-In</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
      body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
      #qr-reader { width: 100%; max-width: 400px; margin: auto; }
      #result { margin-top: 20px; font-size: 16px; }
      button { padding: 10px 20px; margin-top: 10px; font-size: 16px; }
      select { margin-top: 10px; padding: 6px; }
      .offline { color: red; font-weight: bold; margin-top: 10px; }
      .syncing { color: green; font-size: 14px; margin-top: 10px; }
      input, select, textarea, button {
        font-size: 16px;
      }

      /*
      html, body {
        height: 100vh;
        margin: 0;
        padding: 0;
      }
      */
      
      .modal-overlay {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      #mainContent {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      
     body.scanner-active #mainContent {
        visibility: visible;
        opacity: 1;
      }

      #signInModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: block; /* Or display: none; initially */
        overflow-y: auto;
      }
      
      .modal-box {
        width: 90%;
        max-width: 400px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin: 80px auto; /* Restores vertical spacing */
      }
  
    </style>
  </head>
  <body>
    
    <div id="mainContent">
      <h2>QR Check-In-64</h2>
      <!-- SIGN-IN INDICATOR (DISPLAY WHO IS LOGGED IN) -->
      <div id="signedInUser" style="font-size: 13px; color: green; margin-top: 10px;"></div>
      <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 10px;">
        <button id="refreshCameraBtn" onclick="refreshCameraList()" style="margin-left: 8px; padding: 6px 12px; font-size: 14px;">
          Load/Refresh Camera
        </button>
        <button id="signOutButton" style="display: none; font-size: 13px; margin-top: 6px;" onclick="signOut()">Sign Out</button>
      </div>
      
      <div id="qr-reader"></div>
      <div>
        <select id="cameraSelect" onchange="switchCamera()"></select>
      </div>
    
      <div style="margin-top: 20px;">
        <input type="text" id="manualCodeInput" placeholder="Enter code manually (e.g. JOH-12345)" 
               style="padding: 8px; width: 250px;" />
        <button onclick="submitManualCode()">Submit</button>
      </div>
      <div id="result">Waiting for scan...</div>
      <div id="queueHistory" style="margin-top: 10px; font-size: 14px;"></div>
      <div id="offlineBanner" class="offline" style="display: none;">üö´ Offline Mode</div>
      <div id="syncBanner" class="syncing" style="display: none;"></div>
    </div>

    <div id="signInModal" class="modal-overlay" style="display: none;">
      <div class="modal-box">
        <div class="modal-header">
          <h3>Sign In</h3>
          <!--<button onclick="closeSignInModal()" class="modal-close">√ó</button>-->
        </div>
        <hr style="margin: 10px 0;">
        <form style="margin-bottom: 20px;">
          
          <!-- Email input -->
          <div style="margin-bottom: 15px;">
            <input type="email" id="email" placeholder="Enter your email address"
              style="width: calc(100% - 32px); margin: 0 8px 12px 8px; padding:8px; font-size:16px;">
          </div>
    
          <!-- PIN Entry Section -->
          <div id="pinSection" style="display:none; margin-top:20px;">
            <input type="text" id="pin" placeholder="Enter the PIN"
              style="width: calc(100% - 32px); margin: 0 8px 12px 8px; padding:8px; font-size:16px;">
            <button type="button" class="pin-button" onclick="submitPin()">Submit PIN</button>
          </div>
    
          <!-- Hidden name field (autofilled) -->
          <input type="hidden" id="name">
    
          <!-- Continue button -->
          <button type="button" id="emailCheckBtn" class="pin-button" onclick="checkEmailAndRequestPin()">Continue</button>
        </form>
    
        <!-- Status message area -->
        <div id="authMessage" class="authMessage" style="font-size: 14px;"></div>
      </div>
    </div>
    


    <script>
      const backendUrl = "https://script.google.com/macros/s/AKfycbxFuKrVvU0sjb2iif0yZC63IkGVYDJ2A--E1EeVVEoI5zKuApV8NIVX99jSFgu9sBk/exec";
      const qrReader = new Html5Qrcode("qr-reader");
      let currentCameraId = null;
      let availableCameras = [];

      function checkOfflineStatus() {
        const offlineBanner = document.getElementById("offlineBanner");
        if (!navigator.onLine) {
          offlineBanner.style.display = "block";
        } else {
          offlineBanner.style.display = "none";
          syncOfflineQueue(); // attempt sync when reconnecting
        }
      }

      window.addEventListener('online', () => {
        checkOfflineStatus();
        syncOfflineQueue();
      });
      window.addEventListener('offline', checkOfflineStatus);
      checkOfflineStatus();


     function startScanner(cameraId) {
        currentCameraId = cameraId;
        qrReader.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          () => {} // Silent scan errors
        ).catch((err) => {
          console.warn("Initial scanner start failed, retrying...", err);
          setTimeout(() => {
            qrReader.start(
              cameraId,
              { fps: 10, qrbox: 250 },
              onScanSuccess,
              (err) => console.error("Retry scanner start failed", err)
            );
          }, 1000);
        });
      }

      function onScanSuccess(decodedText) {
        const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
        audio.play();
        
          document.getElementById("result").innerHTML = `üîç Scanned: ${decodedText}`;
          qrReader.stop().catch(() => {}).finally(() => {
            processScan(decodedText.trim());
          });
        }

   

      function populateCameraDropdown() {
        const select = document.getElementById("cameraSelect");
        select.innerHTML = "";
        availableCameras.forEach((cam, index) => {
          const option = document.createElement("option");
          option.value = cam.id;
          option.text = cam.label || `Camera ${index + 1}`;
          if (cam.id === currentCameraId) option.selected = true;
          select.appendChild(option);
        });
      }

      function switchCamera() {
        const selectedId = document.getElementById("cameraSelect").value;
        qrReader.stop().catch(() => {}).finally(() => {
          startScanner(selectedId);
        });
      }

      function processScan(code) {
        if (!navigator.onLine) {
          queueOfflineCheckIn(code);
          return;
        }

        lookupGuest(code);
      }

      function lookupGuest(code) {
        fetch(`${backendUrl}?code=${encodeURIComponent(code)}`)
          .then(res => res.json())
          .then(data => {
            if (!data.success) {
              document.getElementById("result").innerHTML = "‚ùå " + data.message;
              restartScanner();
              return;
            }

            if (data.checkedIn) {
              document.getElementById("result").innerHTML =
                `‚úÖ <strong>${data.name}</strong> already checked in<br>${data.timestamp || ""}`;
              restartScanner();
            } else {
              document.getElementById("result").innerHTML =
                `<div style="font-size: 20px; margin-bottom: 10px;">üë§ <strong>${data.name}</strong></div>
                 <button style="font-size: 16px; padding: 10px 20px;" onclick="checkIn('${code}')">‚úÖ Check In Now</button>`;
            }
          });
      }

      function checkIn(code) {
        fetch(`${backendUrl}?code=${encodeURIComponent(code)}&action=checkin`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              document.getElementById("result").innerHTML =
                `‚úÖ <strong>${data.name}</strong> checked in successfully.`;
              restartScanner();
            } else {
              document.getElementById("result").innerHTML = "‚ùå " + data.message;
              restartScanner();
            }
          });
      }

      function restartScanner() {
        setTimeout(() => {
          startScanner(currentCameraId);
        }, 2000);
      }

      // ‚úÖ Offline queue logic
      function getOfflineQueue() {
        return JSON.parse(localStorage.getItem("checkinQueue") || "[]");
      }

      function saveOfflineQueue(queue) {
        localStorage.setItem("checkinQueue", JSON.stringify(queue));
      }

      function queueOfflineCheckIn(code) {
        const queue = getOfflineQueue();
      
        // üîí Prevent duplicate entries
        if (queue.some(entry => entry.code === code)) {
          document.getElementById("result").innerHTML = `‚ö†Ô∏è Already queued: ${code}`;
          restartScanner();
          return;
        }
      
        queue.push({ code, timestamp: new Date().toISOString() });
        saveOfflineQueue(queue);
        const count = queue.length;
        document.getElementById("result").innerHTML = `üì¥ Offline. Queued: ${code} (${count} total)`;
        restartScanner();
        displayOfflineQueue();
      }

      function displayOfflineQueue() {
        const queue = getOfflineQueue();
        const div = document.getElementById("queueHistory");
      
        if (queue.length === 0) {
          div.innerHTML = "";
          return;
        }
      
        const list = queue.map((entry, i) =>
          `${i + 1}. <code>${entry.code}</code> @ ${new Date(entry.timestamp).toLocaleTimeString()}`
        ).join("<br>");
      
        div.innerHTML = `<strong>üïí Queued Check-Ins:</strong><br>${list}`;
      }

      function syncOfflineQueue() {
        const queue = getOfflineQueue();
        if (queue.length === 0) return;
      
        if (!confirm(`Sync ${queue.length} queued check-in(s) now?`)) {
          restartScanner(); // Re-arm the scanner
          return;
        }
      
        const syncBanner = document.getElementById("syncBanner");
        syncBanner.style.display = "block";
        syncBanner.innerText = `üîÅ Syncing ${queue.length} check-in(s)...`;
      
        const updatedQueue = [];
        let completed = 0;
      
        queue.forEach((entry) => {
          fetch(`${backendUrl}?code=${encodeURIComponent(entry.code)}&action=checkin`)
            .then(res => res.json())
            .then(data => {
              if (!data.success) {
                updatedQueue.push(entry); // keep in queue
              }
              syncBanner.innerText = `‚úÖ Synced: ${entry.code}`;
            })
            .catch(() => {
              updatedQueue.push(entry);
              syncBanner.innerText = `‚ùå Failed to sync: ${entry.code}`;
            })
            .finally(() => {
              completed++;
              if (completed === queue.length) {
                saveOfflineQueue(updatedQueue);
                displayOfflineQueue(); // Refresh queue history
      
                setTimeout(() => {
                  syncBanner.style.display = "none";
      
                  if (updatedQueue.length === 0) {
                    document.getElementById("result").innerText = "‚úÖ All pending check-ins synced.";
                    restartScanner();
                  }
                }, 3000);
              }
            });
        });
      }

      Html5Qrcode.getCameras().then(devices => {
        availableCameras = devices;
        if (devices.length === 0) {
          document.getElementById("result").innerText = "‚ùå No camera found.";
          return;
        }
        const backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        populateCameraDropdown();
        //startScanner(backCamera.id);
      });

      function refreshCameraList() {
        location.reload(); // That‚Äôs all
      }

     function refreshCameraListInternally() {
        Html5Qrcode.getCameras().then(devices => {
          availableCameras = devices;
      
          if (devices.length === 0) {
            document.getElementById("result").innerText = "‚ùå No camera found.";
            return;
          }
      
          const backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
          currentCameraId = backCamera.id;
      
          populateCameraDropdown(); // ‚úÖ Move here so it sets the selected option correctly
      
          const restartScanner = () => {
            qrReader.start(
              backCamera.id,
              { fps: 10, qrbox: 250 },
              (decodedText) => {
                document.getElementById("result").innerHTML = `üîç Scanned: ${decodedText}`;
                
                // Delay stop to prevent frame collapse
                setTimeout(() => {
                  qrReader.stop().catch(() => {});
                }, 1000);
                
                processScan(decodedText.trim());
              });
              },
              () => {}
            ).catch(err => {
              console.error("Start scanner failed", err);
            });
          };
      
          if (qrReader._isScanning) {
            qrReader.stop().then(restartScanner).catch(() => {
              console.warn("Stop failed or already stopped");
              restartScanner();
            });
          } else {
            restartScanner();
          }
        });
      }


      function submitManualCode() {
        const input = document.getElementById("manualCodeInput");
        const code = input.value.trim().toUpperCase();
      
        // Optional: enforce basic format like ABC-12345
        if (!/^[A-Z]{3}-\d{5}$/.test(code)) {
          document.getElementById("result").innerHTML = "‚ùå Invalid code format.";
          return;
        }
      
        input.value = ""; // clear input
        document.getElementById("result").innerHTML = `üîç Entered manually: ${code}`;
        processScan(code);
      }

     function openSignInModal() {
        document.getElementById("signInModal").style.display = "block";
        document.body.classList.remove("scanner-active");
      
        setTimeout(() => {
          document.getElementById("email")?.focus();
        }, 100);
      }

      function closeSignInModal() {
        document.getElementById("signInModal").style.display = "none";
        document.body.classList.add("scanner-active");
      
        /* Only initialize scanner if not already done
        if (!qrReader._isScanning) {
          refreshCameraList();
        }
        */
        //refreshCameraList();
      }

      function showAuthMessage(msg) {
        document.getElementById("authMessage").innerHTML = `<p>${msg}</p>`;
      }
    
      function checkEmailAndRequestPin() {
        const email = document.getElementById("email").value.trim().toLowerCase();
        if (!email) return showAuthMessage("Please enter your email.");
      
        showAuthMessage("Checking access...");
      
        fetch(`${backendUrl}?authRequest=1&email=${encodeURIComponent(email)}`, { method: "GET" })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              document.getElementById("name").value = data.name || "Admin";
              document.getElementById("email").disabled = true;
              document.getElementById("emailCheckBtn").style.display = "none";
              document.getElementById("pinSection").style.display = "block";
              
              document.getElementById("pinSection").style.display = "block";
                setTimeout(() => {
                  document.getElementById("pin")?.focus();
                }, 100);
              
              
              showAuthMessage("‚úÖ PIN sent to your email. Please enter it below.");
            } else {
              showAuthMessage("‚ùå " + data.message);
            }
          })
          .catch(() => showAuthMessage("‚ùå Network error. Try again."));
      }
      
      function sendPinAndShowMessage(name, email) {
        showAuthMessage("Sending PIN...");
        fetch(`${backendUrl}?authRequest=1&email=${encodeURIComponent(email)}&name=${encodeURIComponent(name || '')}`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              document.getElementById("pinSection").style.display = "block";
              showAuthMessage("‚úÖ " + data.message);
            } else {
              showAuthMessage("‚ùå " + data.message);
            }
          })
          .catch(() => showAuthMessage("‚ùå Network error. Try again."));
      }
      
      function showPinSection() {
        const nameInput = document.getElementById("name");
        const emailInput = document.getElementById("email");
        const name = nameInput.value.trim();
        const email = emailInput.value.trim().toLowerCase();
        if (!name || !email) return showAuthMessage("Please enter your full name and email.");
      
        document.getElementById("toPinButton").style.display = "none";
        sendPinAndShowMessage(name, email);
      }
    
      function submitPin() {
        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim().toLowerCase();
        const pin = document.getElementById("pin").value.trim();
      
        if (!pin) return showAuthMessage("Enter the PIN sent to your email.");
      
        showAuthMessage("Verifying PIN...");
      
        fetch(`${backendUrl}?authVerify=1&email=${encodeURIComponent(email)}&pin=${encodeURIComponent(pin)}`, { method: "GET" })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              localStorage.setItem("signedInUser", JSON.stringify({ name: data.name, email, pin })); // ‚úÖ Store PIN
              localStorage.setItem("pinTimestamp", Date.now().toString());
              
              closeSignInModal();
              updateSignedInDisplay();
              
            } else {
              showAuthMessage("‚ùå " + data.message);
            }
          })
          .catch(() => showAuthMessage("‚ùå Network error. Try again."));
      }

      function getSignedInUser() {
        const user = JSON.parse(localStorage.getItem("signedInUser"));
        const pinTimestamp = localStorage.getItem("pinTimestamp");
      
        if (!user || !user.email || !user.name || !pinTimestamp) return null;
      
        const elapsedMinutes = (Date.now() - parseInt(pinTimestamp)) / 60000;
        if (elapsedMinutes > 10) {
          localStorage.removeItem("signedInUser");
          localStorage.removeItem("pinTimestamp");
          return null;
        }
      
        return user;
      }
    
      function updateSignedInDisplay() {
        const user = getSignedInUser();
        const div = document.getElementById("signedInUser");
        const signOutBtn = document.getElementById("signOutButton");
      
        if (user && user.email && user.pin) {
          // Re-check PIN silently
          fetch(`${backendUrl}?authVerify=1&email=${encodeURIComponent(user.email)}&pin=${encodeURIComponent(user.pin)}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                div.innerText = `üë§ Signed in as ${data.name}`;
                if (signOutBtn) signOutBtn.style.display = "inline-block";
                closeSignInModal();
                Html5Qrcode.getCameras().then(devices => {
                  availableCameras = devices;
                  populateCameraDropdown();
                });
              } else {
                signOut(); // invalid or expired PIN
              }
            });
        } else {
          div.innerText = "";
          if (signOutBtn) signOutBtn.style.display = "none";
        }
      }

      function signOut() {
        if (!confirm("Are you sure you want to sign out?")) return;
      
        localStorage.removeItem("signedInUser");
        document.getElementById("signedInUser").innerText = "";
        document.getElementById("signOutButton").style.display = "none";
      
        // Reset sign-in modal fields
        document.getElementById("email").value = "";
        document.getElementById("pin").value = "";
        document.getElementById("email").disabled = false;
        document.getElementById("emailCheckBtn").style.display = "block";
        document.getElementById("pinSection").style.display = "none";
        showAuthMessage("");
      
        openSignInModal();
        location.reload();  // üîÑ Reload the page to fully reset state
      }

      function forceSignOut() {
        localStorage.removeItem("signedInUser");
        document.getElementById("signedInUser").innerText = "";
        document.getElementById("signOutButton").style.display = "none";
      
        document.getElementById("email").value = "";
        document.getElementById("pin").value = "";
        document.getElementById("email").disabled = false;
        document.getElementById("emailCheckBtn").style.display = "block";
        document.getElementById("pinSection").style.display = "none";
        showAuthMessage("");
      
        openSignInModal();
        location.reload();
      }

      let inactivityTimeout;

      function resetInactivityTimer() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(() => {
          forceSignOut();
          alert("You were signed out due to inactivity.");
        }, 5 * 60 * 1000); // 5 minutes
      }

      document.addEventListener("mousemove", resetInactivityTimer);
      document.addEventListener("keydown", resetInactivityTimer);
      document.addEventListener("click", resetInactivityTimer);

      
    
      document.addEventListener("DOMContentLoaded", () => {
        const user = getSignedInUser();

        const timestamp = parseInt(localStorage.getItem("pinTimestamp") || "0", 10);
        const now = Date.now();
        const diffMinutes = (now - timestamp) / 60000;
        const isExpired = diffMinutes > 10;
      
        if (user && user.email && user.name && !isExpired) {
          closeSignInModal(); // üîê Skip modal if user is cached and PIN is valid
          updateSignedInDisplay();

          // ‚úÖ Auto refresh camera after reload
          setTimeout(refreshCameraListInternally, 300);
        } else {
          localStorage.removeItem("signedInUser");
          localStorage.removeItem("pinTimestamp");
          openSignInModal(); // Show modal if no login or expired PIN
        }
      
        resetInactivityTimer();
      
        // ‚å®Ô∏è Keyboard shortcut helper
        function bindEnterKey(inputId, callback) {
          const input = document.getElementById(inputId);
          if (!input) return;
      
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              if (typeof callback === "function") {
                callback();
              } else {
                document.getElementById(callback)?.click();
              }
            }
          });
        }
      
        bindEnterKey("email", "emailCheckBtn");
        bindEnterKey("pin", submitPin);
      });
    </script>
  </body>
</html>
