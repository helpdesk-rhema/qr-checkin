<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>QR Check-In</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
      body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
      #qr-reader { width: 100%; max-width: 400px; margin: auto; }
      #result { margin-top: 20px; font-size: 16px; }
      button { padding: 10px 20px; margin-top: 10px; font-size: 16px; }
      select { margin-top: 10px; padding: 6px; }
      .offline { color: red; font-weight: bold; margin-top: 10px; }
      .syncing { color: green; font-size: 14px; margin-top: 10px; }
    </style>
  </head>
  <body>
    <h2>QR Check-In</h2>
    <div id="qr-reader"></div>
    <div>
      <select id="cameraSelect" onchange="switchCamera()"></select>
    </div>
    <div style="margin-top: 20px;">
      <input type="text" id="manualCodeInput" placeholder="Enter code manually (e.g. JOH-12345)" 
             style="padding: 8px; width: 250px;" />
      <button onclick="submitManualCode()">Submit</button>
    </div>
    <div id="result">Waiting for scan...</div>
    <div id="queueHistory" style="margin-top: 10px; font-size: 14px;"></div>
    <div id="offlineBanner" class="offline" style="display: none;">üö´ Offline Mode</div>
    <div id="syncBanner" class="syncing" style="display: none;"></div>

    <script>
      const backendUrl = "https://script.google.com/macros/s/AKfycbxFuKrVvU0sjb2iif0yZC63IkGVYDJ2A--E1EeVVEoI5zKuApV8NIVX99jSFgu9sBk/exec";
      const qrReader = new Html5Qrcode("qr-reader");
      let currentCameraId = null;
      let availableCameras = [];

      function checkOfflineStatus() {
        const offlineBanner = document.getElementById("offlineBanner");
        if (!navigator.onLine) {
          offlineBanner.style.display = "block";
        } else {
          offlineBanner.style.display = "none";
          syncOfflineQueue(); // attempt sync when reconnecting
        }
      }

      window.addEventListener('online', () => {
        checkOfflineStatus();
        syncOfflineQueue();
      });
      window.addEventListener('offline', checkOfflineStatus);
      checkOfflineStatus();

      function startScanner(cameraId) {
        currentCameraId = cameraId;
        qrReader.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            document.getElementById("result").innerHTML = `üîç Scanned: ${decodedText}`;
            qrReader.stop().catch(() => {}).finally(() => {
              processScan(decodedText.trim());
            });
          },
          (err) => {} // Silent scan errors
        );
      }

      function populateCameraDropdown() {
        const select = document.getElementById("cameraSelect");
        select.innerHTML = "";
        availableCameras.forEach((cam, index) => {
          const option = document.createElement("option");
          option.value = cam.id;
          option.text = cam.label || `Camera ${index + 1}`;
          if (cam.id === currentCameraId) option.selected = true;
          select.appendChild(option);
        });
      }

      function switchCamera() {
        const selectedId = document.getElementById("cameraSelect").value;
        qrReader.stop().catch(() => {}).finally(() => {
          startScanner(selectedId);
        });
      }

      function processScan(code) {
        if (!navigator.onLine) {
          queueOfflineCheckIn(code);
          return;
        }

        lookupGuest(code);
      }

      function lookupGuest(code) {
        fetch(`${backendUrl}?code=${encodeURIComponent(code)}`)
          .then(res => res.json())
          .then(data => {
            if (!data.success) {
              document.getElementById("result").innerHTML = "‚ùå " + data.message;
              restartScanner();
              return;
            }

            if (data.checkedIn) {
              document.getElementById("result").innerHTML =
                `‚úÖ <strong>${data.name}</strong> already checked in<br>${data.timestamp || ""}`;
              restartScanner();
            } else {
              document.getElementById("result").innerHTML =
                `üë§ <strong>${data.name}</strong><br><button onclick="checkIn('${code}')">‚úÖ Mark as Checked In</button>`;
            }
          });
      }

      function checkIn(code) {
        fetch(`${backendUrl}?code=${encodeURIComponent(code)}&action=checkin`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              document.getElementById("result").innerHTML =
                `‚úÖ <strong>${data.name}</strong> checked in successfully.`;
              restartScanner();
            } else {
              document.getElementById("result").innerHTML = "‚ùå " + data.message;
              restartScanner();
            }
          });
      }

      function restartScanner() {
        setTimeout(() => {
          startScanner(currentCameraId);
        }, 2000);
      }

      // ‚úÖ Offline queue logic
      function getOfflineQueue() {
        return JSON.parse(localStorage.getItem("checkinQueue") || "[]");
      }

      function saveOfflineQueue(queue) {
        localStorage.setItem("checkinQueue", JSON.stringify(queue));
      }

      function queueOfflineCheckIn(code) {
        const queue = getOfflineQueue();
      
        // üîí Prevent duplicate entries
        if (queue.some(entry => entry.code === code)) {
          document.getElementById("result").innerHTML = `‚ö†Ô∏è Already queued: ${code}`;
          restartScanner();
          return;
        }
      
        queue.push({ code, timestamp: new Date().toISOString() });
        saveOfflineQueue(queue);
        const count = queue.length;
        document.getElementById("result").innerHTML = `üì¥ Offline. Queued: ${code} (${count} total)`;
        restartScanner();
        displayOfflineQueue();
      }

      function displayOfflineQueue() {
        const queue = getOfflineQueue();
        const div = document.getElementById("queueHistory");
      
        if (queue.length === 0) {
          div.innerHTML = "";
          return;
        }
      
        const list = queue.map((entry, i) =>
          `${i + 1}. <code>${entry.code}</code> @ ${new Date(entry.timestamp).toLocaleTimeString()}`
        ).join("<br>");
      
        div.innerHTML = `<strong>üïí Queued Check-Ins:</strong><br>${list}`;
      }

      function syncOfflineQueue() {
        const queue = getOfflineQueue();
        if (queue.length === 0) return;
      
        if (!confirm(`Sync ${queue.length} queued check-in(s) now?`)) {
          restartScanner(); // Re-arm the scanner
          return;
        }
      
        const syncBanner = document.getElementById("syncBanner");
        syncBanner.style.display = "block";
        syncBanner.innerText = `üîÅ Syncing ${queue.length} check-in(s)...`;
      
        const updatedQueue = [];
        let completed = 0;
      
        queue.forEach((entry) => {
          fetch(`${backendUrl}?code=${encodeURIComponent(entry.code)}&action=checkin`)
            .then(res => res.json())
            .then(data => {
              if (!data.success) {
                updatedQueue.push(entry); // keep in queue
              }
              syncBanner.innerText = `‚úÖ Synced: ${entry.code}`;
            })
            .catch(() => {
              updatedQueue.push(entry);
              syncBanner.innerText = `‚ùå Failed to sync: ${entry.code}`;
            })
            .finally(() => {
              completed++;
              if (completed === queue.length) {
                saveOfflineQueue(updatedQueue);
                displayOfflineQueue(); // Refresh queue history
      
                setTimeout(() => {
                  syncBanner.style.display = "none";
      
                  if (updatedQueue.length === 0) {
                    document.getElementById("result").innerText = "‚úÖ All pending check-ins synced.";
                    restartScanner();
                  }
                }, 3000);
              }
            });
        });
      }

      Html5Qrcode.getCameras().then(devices => {
        availableCameras = devices;
        if (devices.length === 0) {
          document.getElementById("result").innerText = "‚ùå No camera found.";
          return;
        }
        const backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        populateCameraDropdown();
        startScanner(backCamera.id);
      });

      function submitManualCode() {
        const input = document.getElementById("manualCodeInput");
        const code = input.value.trim().toUpperCase();
      
        // Optional: enforce basic format like ABC-12345
        if (!/^[A-Z]{3}-\d{5}$/.test(code)) {
          document.getElementById("result").innerHTML = "‚ùå Invalid code format.";
          return;
        }
      
        input.value = ""; // clear input
        document.getElementById("result").innerHTML = `üîç Entered manually: ${code}`;
        processScan(code);
      }
    </script>
  </body>
</html>
