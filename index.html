<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>QR Check-In</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
      body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
      #qr-reader { width: 100%; max-width: 400px; margin: auto; }
      #result { margin-top: 20px; font-size: 16px; }
      button { padding: 10px 20px; margin-top: 10px; font-size: 16px; }
    </style>
  </head>
  <body>
    <h2>QR Check-In</h2>
    <div id="qr-reader"></div>
    <div id="result">Waiting for scan...</div>

    <script>
      const backendUrl = "https://script.google.com/macros/s/AKfycbxFuKrVvU0sjb2iif0yZC63IkGVYDJ2A--E1EeVVEoI5zKuApV8NIVX99jSFgu9sBk/exec";

      function lookupGuest(code) {
        fetch(`${backendUrl}?code=${encodeURIComponent(code)}`)
          .then(res => res.json())
          .then(data => {
            if (!data.success) {
              document.getElementById("result").innerHTML = "‚ùå " + data.message;
              return;
            }

            if (data.checkedIn) {
              document.getElementById("result").innerHTML =
                `‚úÖ <strong>${data.name}</strong> already checked in<br>${data.timestamp || ""}`;
            } else {
              document.getElementById("result").innerHTML =
                `üë§ <strong>${data.name}</strong><br><button onclick="checkIn('${code}')">‚úÖ Mark as Checked In</button>`;
            }
          });
      }

      function checkIn(code) {
        fetch(`${backendUrl}?code=${encodeURIComponent(code)}&action=checkin`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              document.getElementById("result").innerHTML = `‚úÖ <strong>${data.name}</strong> checked in successfully.`;
            } else {
              document.getElementById("result").innerHTML = "‚ùå " + data.message;
            }
          });
      }

      const qrReader = new Html5Qrcode("qr-reader");

      Html5Qrcode.getCameras().then(devices => {
        if (devices.length === 0) {
          document.getElementById("result").innerText = "‚ùå No camera found.";
          return;
        }

        const cameraId = devices[0].id;
        qrReader.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            document.getElementById("result").innerHTML = `üîç Scanned: ${decodedText}`;
            qrReader.stop();
            lookupGuest(decodedText.trim());
          },
          (err) => {}
        );
      });
    </script>
  </body>
</html>
